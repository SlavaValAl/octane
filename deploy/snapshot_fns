# vim syntax=sh
STATE_PATH="/vms/state"

zfs_snapshot() {
  local volume=$1 snapname=$2
  sudo zfs snapshot vms/$volume@$snapname
  sudo zfs clone vms/$volume@$snapname vms/$volume-$snapname
  sudo zfs promote vms/$volume-$snapname
}

zfs_revert() {
  local volume=$1 snapname=$2
  sudo zfs destroy vms/$volume
  sudo zfs clone vms/$volume-$snapname@$snapname vms/$volume
}

zfs_discard() {
  local volume=$1 snapname=$2
  clones="$(sudo zfs get -H clones vms/$volume-$snapname@$snapname | cut -f3)"
  case $clones in
  "" )
    sudo zfs destroy vms/$volume-$snapname@$snapname
    sudo zfs destroy vms/$volume-$snapname
    ;;
  vms/$volume )
    sudo zfs promote vms/$volume
    sudo zfs destroy vms/$volume-$snapname
    sudo zfs destroy vms/$volume@$snapname
    ;;
  * )
    echo "Can't remove snapshot vms/$volume-$snapname@$snapname since it has clones: $clones"
  esac
}

virsh_all() {
  local action=$1
  shift
  echo "$@" | xargs -P0 -n1 virsh $action | sed -n '/./p'
}

snapshot_vms() {
  local snapname=$1 domain snap_arg
  shift
  sudo mkdir -p "$STATE_PATH"
  sudo chown libvirt-qemu:kvm "$STATE_PATH"
  virsh_all suspend "$@"
  for domain; do
    zfs_snapshot $domain $snapname
    snap_arg=""
    case $domain in
    fuel )
      snap_arg="--diskspec hdb,snapshot=no"
      ;;
    compute-* )
      snap_arg="--diskspec hdb,snapshot=no"
      zfs_snapshot $domain-ceph $snapname
      ;;
    esac
    virsh snapshot-create-as $domain $domain-$snapname --atomic --memspec "$STATE_PATH/$domain-$snapname" --diskspec hda,snapshot=no $snap_arg
  done
  virsh_all resume "$@"
}

revert_vms() {
  local snapname=$1 domain
  shift
  virsh_all destroy "$@"
  for domain; do
    zfs_revert $domain $snapname
    case $domain in
    compute-* )
      zfs_revert $domain-ceph $snapname
      ;;
    esac
    virsh restore "$STATE_PATH/$domain-$snapname" --paused
  done
  virsh_all resume "$@"
}

discard_snapshots() {
  local snapname=$1 domain
  shift
  for domain; do
    rm -f "$STATE_PATH/$domain-$snapname"
    zfs_discard $domain $snapname
    case $domain in
    compute-* )
      zfs_discard $domain-ceph $snapname
      ;;
    esac
  done
}
